{% extends 'base_app.html' %}
{% block title %}Account – {{ app_name }}{% endblock %}
{% block content %}
<div class="w-full max-w-4xl">
  <h1 class="text-2xl font-semibold mb-4">Your Account</h1>

  <!-- Subscription card -->
  <div class="bg-white border rounded-xl p-6 mb-6">
    <div class="flex items-center justify-between">
      <div>
        <h2 class="text-lg font-semibold">
          {% if subscription and plan %}
            Plan: {{ plan|capitalize }}
          {% elif subscription %}
            Plan: {{ subscription.price_id or 'Unknown' }}
          {% else %}
            Plan: Free
          {% endif %}
        </h2>
        <p class="text-sm text-gray-600 mt-1">
          {% if subscription and subscription.status %}
            Status: {{ subscription.status }}
            {% if subscription.current_period_end %}
              • Renews {{ subscription.current_period_end.strftime('%Y-%m-%d') }}
            {% endif %}
          {% else %}
            No active subscription.
          {% endif %}
        </p>
      </div>

      <div class="flex gap-2">
        {% if portal_link %}
          <a href="{{ url_for('account_bp.billing_portal') }}"
             class="px-3 py-2 border rounded hover:bg-gray-50">
            Manage billing
          </a>
        {% endif %}
      </div>
    </div>

    {% if not subscription or subscription.status not in ('active','trialing','past_due') %}
      <div class="mt-4 flex gap-3">
        <form method="post" action="{{ url_for('account_bp.billing_checkout_plan', plan='monthly') }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">
            Upgrade – Monthly
          </button>
        </form>
        <form method="post" action="{{ url_for('account_bp.billing_checkout_plan', plan='yearly') }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">
            Upgrade – Yearly
          </button>
        </form>
      </div>
    {% endif %}
  </div>

  <!-- Payment history -->
  <div class="bg-white border rounded-xl p-6">
    <h3 class="text-lg font-semibold mb-3">Recent Payments</h3>
    {% if payments and payments|length %}
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="text-left border-b">
              <th class="py-2 pr-4">Date</th>
              <th class="py-2 pr-4">Invoice</th>
              <th class="py-2 pr-4">Amount</th>
              <th class="py-2 pr-4">Status</th>
            </tr>
          </thead>
          <tbody>
            {% for p in payments %}
              <tr class="border-b last:border-0">
                <td class="py-2 pr-4">{{ p.created_at.strftime('%Y-%m-%d %H:%M') if p.created_at else '-' }}</td>
                <td class="py-2 pr-4">{{ p.invoice_id or '-' }}</td>
                <td class="py-2 pr-4">
                  {% if p.amount is not none %}
                    {{ (p.amount / 100.0)|round(2) }} {{ p.currency|upper if p.currency else '' }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td class="py-2 pr-4">{{ p.status or '-' }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="text-gray-600">No payments yet.</p>
    {% endif %}
  </div>
</div>
{% endblock %}
