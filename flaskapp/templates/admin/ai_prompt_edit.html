{% extends "base_admin.html" %}
{% block title %}Edit AI Prompt â€“ {{ prompt.name }}{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto">
  <!-- Header -->
  <div class="flex items-center justify-between mb-6">
    <div>
      <h1 class="text-2xl font-bold">Edit AI Prompt</h1>
      <p class="text-sm text-gray-600 mt-1">{{ prompt.name }} <span class="font-mono text-xs">({{ prompt.prompt_key }})</span></p>
    </div>
    <a href="{{ url_for('admin_bp.ai_prompts_list') }}"
       class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium transition-colors">
      <i class="fa-solid fa-arrow-left mr-1"></i> Back to Prompts
    </a>
  </div>

  <!-- Security Notice -->
  <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6 flex items-start gap-3">
    <i class="fa-solid fa-lock text-green-600 text-xl mt-0.5"></i>
    <div class="text-sm text-green-900">
      <strong>Secure Server-Side Storage:</strong> This prompt is stored exclusively on the server and is never transmitted to the browser.
      Users cannot access it through view source, developer tools, network inspection, or any other client-side method.
    </div>
  </div>

  <!-- Edit Form -->
  <form method="post" action="{{ url_for('admin_bp.ai_prompt_update', prompt_id=prompt.id) }}" class="space-y-6">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <!-- Basic Info -->
    <div class="bg-white border rounded-lg p-6">
      <h2 class="text-lg font-semibold mb-4">Basic Information</h2>

      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
          <input type="text" name="name" value="{{ prompt.name }}" required
                 class="w-full border rounded-md px-3 py-2">
          <p class="text-xs text-gray-500 mt-1">Human-readable name for this prompt</p>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
          <textarea name="description" rows="2"
                    class="w-full border rounded-md px-3 py-2">{{ prompt.description or '' }}</textarea>
          <p class="text-xs text-gray-500 mt-1">Brief description of what this prompt does</p>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1 flex items-center gap-2">
            <span>Active</span>
            <input type="checkbox" name="is_active" {% if prompt.is_active %}checked{% endif %}
                   class="rounded border-gray-300">
          </label>
          <p class="text-xs text-gray-500 mt-1">Only active prompts will be used by the system</p>
        </div>
      </div>
    </div>

    <!-- Model Settings -->
    <div class="bg-white border rounded-lg p-6">
      <h2 class="text-lg font-semibold mb-4">Model Configuration</h2>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Model</label>
          <select name="model" class="w-full border rounded-md px-3 py-2">
            <option value="gpt-4o-mini" {% if prompt.model == 'gpt-4o-mini' %}selected{% endif %}>GPT-4o Mini</option>
            <option value="gpt-4o" {% if prompt.model == 'gpt-4o' %}selected{% endif %}>GPT-4o</option>
            <option value="gpt-4-turbo" {% if prompt.model == 'gpt-4-turbo' %}selected{% endif %}>GPT-4 Turbo</option>
            <option value="gpt-4" {% if prompt.model == 'gpt-4' %}selected{% endif %}>GPT-4</option>
            <option value="gpt-3.5-turbo" {% if prompt.model == 'gpt-3.5-turbo' %}selected{% endif %}>GPT-3.5 Turbo</option>
          </select>
          <p class="text-xs text-gray-500 mt-1">OpenAI model to use</p>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Temperature</label>
          <input type="number" name="temperature" value="{{ prompt.temperature }}" step="0.1" min="0" max="2"
                 class="w-full border rounded-md px-3 py-2">
          <p class="text-xs text-gray-500 mt-1">0.0 = deterministic, 2.0 = creative</p>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Max Tokens</label>
          <input type="number" name="max_tokens" value="{{ prompt.max_tokens }}" min="100" max="4000"
                 class="w-full border rounded-md px-3 py-2">
          <p class="text-xs text-gray-500 mt-1">Maximum response length</p>
        </div>
      </div>
    </div>

    <!-- System Message -->
    <div class="bg-white border rounded-lg p-6">
      <h2 class="text-lg font-semibold mb-4">System Message</h2>
      <p class="text-sm text-gray-600 mb-3">The system message sets the behavior and role of the AI assistant.</p>

      <textarea name="system_message" rows="3"
                class="w-full border rounded-md px-3 py-2 font-mono text-sm">{{ prompt.system_message or '' }}</textarea>

      <div class="mt-2 text-xs text-gray-500">
        <strong>Example:</strong> "You are a Google Ads optimization expert providing data-driven recommendations in JSON format."
      </div>
    </div>

    <!-- Prompt Template -->
    <div class="bg-white border rounded-lg p-6">
      <h2 class="text-lg font-semibold mb-4">Prompt Template</h2>
      <p class="text-sm text-gray-600 mb-3">
        The main prompt sent to the AI. You can use placeholders like <code class="bg-gray-100 px-1 rounded">{performance_summary}</code>,
        <code class="bg-gray-100 px-1 rounded">{campaigns_data}</code>, etc. which will be replaced with actual data.
      </p>

      <textarea name="prompt_template" rows="25" required
                class="w-full border rounded-md px-3 py-2 font-mono text-sm">{{ prompt.prompt_template }}</textarea>

      <div class="mt-3 p-3 bg-blue-50 border border-blue-200 rounded text-xs">
        <strong class="text-blue-900">Available Placeholders (vary by service):</strong>
        <ul class="mt-2 space-y-1 text-blue-800">
          <li><strong>Google Ads:</strong> {performance_summary}, {campaigns_data}, {ad_groups_data}, {keywords_data}, {search_terms_data}</li>
          <li><strong>Google Analytics:</strong> {sessions}, {users}, {engagement_rate}, {top_pages}, {top_sources}, {conversions_data}</li>
          <li><strong>Search Console:</strong> {clicks}, {impressions}, {avg_ctr}, {avg_position}, {top_pages}, {top_queries}, {low_ctr_queries}</li>
        </ul>
      </div>
    </div>

    <!-- Submit Button -->
    <div class="flex items-center justify-between">
      <a href="{{ url_for('admin_bp.ai_prompts_list') }}"
         class="px-6 py-2 border border-gray-300 hover:bg-gray-50 rounded-lg text-sm font-medium transition-colors">
        Cancel
      </a>
      <button type="submit"
              class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-medium transition-colors">
        <i class="fa-solid fa-save mr-1"></i> Save Changes
      </button>
    </div>
  </form>

  <!-- Metadata -->
  <div class="mt-6 p-4 bg-gray-50 border rounded-lg text-xs text-gray-600">
    <div class="grid grid-cols-2 gap-2">
      <div><strong>Created:</strong> {{ prompt.created_at.strftime('%Y-%m-%d %H:%M:%S UTC') if prompt.created_at else 'Unknown' }}</div>
      <div><strong>Last Updated:</strong> {{ prompt.updated_at.strftime('%Y-%m-%d %H:%M:%S UTC') if prompt.updated_at else 'Never' }}</div>
    </div>
  </div>

</div>
{% endblock %}
