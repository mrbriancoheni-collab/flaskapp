{% extends "base_app.html" %}
{% set SECTION = 'billing' %}
{% block title %}Billing Portal Â· {{ app_name }}{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto space-y-8">

  <!-- Header -->
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-semibold text-gray-900">Billing & Subscription</h1>
      <p class="text-gray-500 mt-1">Manage your subscription, billing, and payment methods.</p>
    </div>
    {% if not subscriptions or subscriptions[0].status not in ['active', 'trialing'] %}
    <a href="{{ url_for('billing.choose_plan') }}"
       class="rounded-md bg-violet-600 text-white px-4 py-2 hover:bg-violet-700 transition">
      Choose a Plan
    </a>
    {% endif %}
  </div>

  <!-- Current Subscription -->
  {% if subscriptions and subscriptions[0].status in ['active', 'trialing'] %}
  {% set sub = subscriptions[0] %}
  <div class="bg-white rounded-lg border">
    <div class="px-6 py-4 border-b">
      <h2 class="text-lg font-medium text-gray-900">Current Subscription</h2>
    </div>

    <div class="p-6">
      <div class="flex items-start justify-between">
        <!-- Subscription Info -->
        <div class="flex-1">
          <div class="flex items-center gap-3">
            <h3 class="text-xl font-semibold text-gray-900">
              {% if sub.price_id == config.STRIPE_MONTHLY_PRICE_ID %}
                Growth Plan (Monthly)
              {% elif sub.price_id == config.STRIPE_YEARLY_PRICE_ID %}
                Growth Plan (Annual)
              {% else %}
                Subscribed
              {% endif %}
            </h3>

            <!-- Status Badge -->
            {% if sub.status == 'active' %}
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                <i class="fas fa-check-circle mr-1"></i>
                Active
              </span>
            {% elif sub.status == 'trialing' %}
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                <i class="fas fa-gift mr-1"></i>
                Trial
              </span>
            {% elif sub.status == 'past_due' %}
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-800">
                <i class="fas fa-exclamation-triangle mr-1"></i>
                Past Due
              </span>
            {% endif %}
          </div>

          <div class="mt-4 space-y-2 text-sm text-gray-600">
            <div class="flex items-center gap-2">
              <i class="fas fa-calendar text-gray-400 w-4"></i>
              <span>
                {% if sub.status == 'trialing' %}
                  Trial ends {{ sub.current_period_end.strftime('%B %d, %Y') }}
                {% else %}
                  Renews {{ sub.current_period_end.strftime('%B %d, %Y') }}
                {% endif %}
              </span>
            </div>

            {% if sub.cancel_at_period_end %}
            <div class="flex items-center gap-2 text-amber-600">
              <i class="fas fa-info-circle text-amber-500 w-4"></i>
              <span>Scheduled to cancel on {{ sub.current_period_end.strftime('%B %d, %Y') }}</span>
            </div>
            {% endif %}
          </div>
        </div>

        <!-- Actions -->
        <div class="flex flex-col gap-2">
          {% if not sub.cancel_at_period_end %}
            <!-- Upgrade/Downgrade -->
            {% if sub.price_id == config.STRIPE_MONTHLY_PRICE_ID %}
            <form method="POST" action="{{ url_for('billing.upgrade') }}">
              <input type="hidden" name="subscription_id" value="{{ sub.stripe_subscription_id }}">
              <input type="hidden" name="price_id" value="{{ config.STRIPE_YEARLY_PRICE_ID }}">
              <button type="submit"
                      class="w-full px-4 py-2 bg-violet-600 text-white text-sm rounded-md hover:bg-violet-700 transition">
                Upgrade to Annual
              </button>
            </form>
            {% elif sub.price_id == config.STRIPE_YEARLY_PRICE_ID %}
            <form method="POST" action="{{ url_for('billing.upgrade') }}">
              <input type="hidden" name="subscription_id" value="{{ sub.stripe_subscription_id }}">
              <input type="hidden" name="price_id" value="{{ config.STRIPE_MONTHLY_PRICE_ID }}">
              <button type="submit"
                      class="w-full px-4 py-2 border border-gray-300 text-gray-700 text-sm rounded-md hover:bg-gray-50 transition">
                Switch to Monthly
              </button>
            </form>
            {% endif %}

            <!-- Cancel -->
            <button onclick="cancelSubscription('{{ sub.stripe_subscription_id }}')"
                    class="px-4 py-2 text-sm text-red-600 hover:text-red-700 transition">
              Cancel Subscription
            </button>
          {% else %}
            <!-- Reactivate -->
            <form method="POST" action="{{ url_for('billing.reactivate') }}">
              <input type="hidden" name="subscription_id" value="{{ sub.stripe_subscription_id }}">
              <button type="submit"
                      class="w-full px-4 py-2 bg-green-600 text-white text-sm rounded-md hover:bg-green-700 transition">
                Reactivate Subscription
              </button>
            </form>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Features Included -->
  <div class="bg-white rounded-lg border">
    <div class="px-6 py-4 border-b">
      <h3 class="font-medium text-gray-900">Features Included</h3>
    </div>
    <div class="p-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="flex items-start gap-3">
          <i class="fas fa-check-circle text-green-500 mt-0.5"></i>
          <div>
            <div class="font-medium text-gray-900">AI Campaign Suggestions</div>
            <div class="text-sm text-gray-500">Get weekly optimization recommendations</div>
          </div>
        </div>
        <div class="flex items-start gap-3">
          <i class="fas fa-check-circle text-green-500 mt-0.5"></i>
          <div>
            <div class="font-medium text-gray-900">Lead Quality Insights</div>
            <div class="text-sm text-gray-500">Track conversion performance</div>
          </div>
        </div>
        <div class="flex items-start gap-3">
          <i class="fas fa-check-circle text-green-500 mt-0.5"></i>
          <div>
            <div class="font-medium text-gray-900">A/B Creative Tips</div>
            <div class="text-sm text-gray-500">Test and optimize your ads</div>
          </div>
        </div>
        <div class="flex items-start gap-3">
          <i class="fas fa-check-circle text-green-500 mt-0.5"></i>
          <div>
            <div class="font-medium text-gray-900">Team Collaboration</div>
            <div class="text-sm text-gray-500">Up to 10 team members</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {% else %}
    <!-- No Active Subscription -->
    <div class="bg-gradient-to-br from-violet-50 to-purple-50 rounded-lg border border-violet-200 p-8 text-center">
      <div class="w-16 h-16 bg-violet-100 rounded-full flex items-center justify-center mx-auto mb-4">
        <i class="fas fa-rocket text-violet-600 text-2xl"></i>
      </div>
      <h3 class="text-xl font-semibold text-gray-900 mb-2">No Active Subscription</h3>
      <p class="text-gray-600 mb-6">
        Upgrade to unlock AI-powered insights, advanced reports, and team collaboration.
      </p>
      <a href="{{ url_for('billing.choose_plan') }}"
         class="inline-flex items-center gap-2 px-6 py-3 bg-violet-600 text-white rounded-md hover:bg-violet-700 transition">
        <i class="fas fa-sparkles"></i>
        View Plans
      </a>
    </div>
  {% endif %}

  <!-- Payment History -->
  <div class="bg-white rounded-lg border">
    <div class="px-6 py-4 border-b">
      <h2 class="text-lg font-medium text-gray-900">Payment History</h2>
    </div>

    {% if payments %}
    <div class="divide-y">
      {% for payment in payments %}
      <div class="px-6 py-4 flex items-center justify-between hover:bg-gray-50 transition">
        <div class="flex items-center gap-4">
          <div class="w-10 h-10 rounded-full {% if payment.status == 'paid' %}bg-green-100{% else %}bg-red-100{% endif %} flex items-center justify-center">
            <i class="fas {% if payment.status == 'paid' %}fa-check text-green-600{% else %}fa-times text-red-600{% endif %}"></i>
          </div>
          <div>
            <div class="font-medium text-gray-900">
              ${{ (payment.amount / 100)|round(2) }} {{ payment.currency|upper }}
            </div>
            <div class="text-sm text-gray-500">
              {{ payment.created_at.strftime('%B %d, %Y at %I:%M %p') }}
            </div>
          </div>
        </div>
        <div class="flex items-center gap-3">
          {% if payment.status == 'paid' %}
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
              Paid
            </span>
          {% else %}
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
              Failed
            </span>
          {% endif %}
          {% if payment.invoice_id %}
          <a href="#" class="text-sm text-violet-600 hover:text-violet-700">
            View Invoice
          </a>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="px-6 py-12 text-center text-gray-500">
      <i class="fas fa-receipt text-4xl mb-3 text-gray-300"></i>
      <p>No payment history yet</p>
    </div>
    {% endif %}
  </div>

  <!-- Billing Details -->
  {% if customer %}
  <div class="bg-white rounded-lg border">
    <div class="px-6 py-4 border-b">
      <h2 class="text-lg font-medium text-gray-900">Billing Details</h2>
    </div>
    <div class="p-6">
      <div class="space-y-3 text-sm">
        <div class="flex justify-between">
          <span class="text-gray-500">Customer ID</span>
          <span class="font-mono text-gray-700">{{ customer.stripe_customer_id }}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-500">Account Created</span>
          <span class="text-gray-700">{{ customer.created_at.strftime('%B %d, %Y') }}</span>
        </div>
      </div>
      <div class="mt-6 pt-6 border-t">
        <a href="#" class="text-sm text-violet-600 hover:text-violet-700 flex items-center gap-2">
          <i class="fas fa-credit-card"></i>
          Manage Payment Methods
        </a>
      </div>
    </div>
  </div>
  {% endif %}

</div>

<!-- Cancel Subscription Modal -->
<div id="cancel-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg max-w-md w-full mx-4">
    <div class="px-6 py-4 border-b">
      <h3 class="text-lg font-semibold">Cancel Subscription?</h3>
    </div>

    <div class="p-6 space-y-4">
      <p class="text-gray-600">
        Are you sure you want to cancel your subscription? You'll lose access to premium features at the end of your billing period.
      </p>

      <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
        <div class="flex gap-3">
          <i class="fas fa-exclamation-triangle text-amber-600 mt-0.5"></i>
          <div class="text-sm text-amber-800">
            <div class="font-medium mb-1">What you'll lose:</div>
            <ul class="list-disc list-inside space-y-1">
              <li>AI campaign suggestions</li>
              <li>Advanced analytics</li>
              <li>Team collaboration features</li>
              <li>Priority support</li>
            </ul>
          </div>
        </div>
      </div>

      <form id="cancel-form" method="POST" action="{{ url_for('billing.cancel') }}" class="space-y-3">
        <input type="hidden" name="subscription_id" id="cancel-sub-id">

        <label class="flex items-center gap-2 text-sm">
          <input type="checkbox" name="immediate" value="true" class="rounded">
          <span>Cancel immediately (instead of at period end)</span>
        </label>

        <!-- Actions -->
        <div class="flex gap-3 pt-2">
          <button type="button"
                  onclick="document.getElementById('cancel-modal').classList.add('hidden')"
                  class="flex-1 px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition">
            Keep Subscription
          </button>
          <button type="submit"
                  class="flex-1 px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition">
            Cancel Subscription
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
function cancelSubscription(subscriptionId) {
  document.getElementById('cancel-sub-id').value = subscriptionId;
  document.getElementById('cancel-modal').classList.remove('hidden');
}

// Handle cancel form submission
document.getElementById('cancel-form').addEventListener('submit', function(e) {
  e.preventDefault();

  const formData = new FormData(this);

  fetch(this.action, {
    method: 'POST',
    headers: {
      'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
    },
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      window.location.reload();
    } else {
      alert('Error: ' + data.error);
    }
  })
  .catch(error => {
    alert('Failed to cancel subscription: ' + error);
  });
});
</script>
{% endblock %}
