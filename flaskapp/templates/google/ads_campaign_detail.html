{# templates/google/ads_campaign_detail.html - Level 2: Campaign Detail with Ad Groups #}
{% extends "base_app.html" %}
{% set SECTION = 'google' %}
{% block title %}{{ campaign.name }} - Google Ads{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto space-y-6">
  {# Breadcrumbs #}
  <nav class="flex items-center text-sm text-gray-500">
    <a href="{{ url_for('google_bp.ads_campaigns') }}" class="hover:text-gray-700">
      <i class="fa-solid fa-bullhorn mr-1"></i> Google Ads
    </a>
    <i class="fa-solid fa-chevron-right mx-2 text-xs"></i>
    <span class="text-gray-900 font-medium">{{ campaign.name }}</span>
  </nav>

  {# Campaign Header #}
  <div class="rounded-lg border bg-white p-6">
    <div class="flex items-start justify-between">
      <div class="flex-1">
        <div class="flex items-center gap-3 mb-2">
          <h1 class="text-2xl font-semibold">{{ campaign.name }}</h1>
          <span class="inline-flex items-center rounded-full px-2 py-1 text-xs font-medium
            {% if campaign.status == 'Enabled' %}bg-green-50 text-green-700 border border-green-200
            {% else %}bg-gray-50 text-gray-600 border border-gray-200{% endif %}">
            {% if campaign.status == 'Enabled' %}● {% endif %}{{ campaign.status }}
          </span>
          <span class="text-sm text-gray-500">{{ campaign.type }}</span>
        </div>

        <div class="grid grid-cols-4 gap-6 mt-4">
          <div>
            <div class="text-xs text-gray-500 mb-1">Daily Budget</div>
            <div class="text-lg font-semibold">${{ campaign.daily_budget }}</div>
          </div>
          <div>
            <div class="text-xs text-gray-500 mb-1">Bidding Strategy</div>
            <div class="text-lg font-semibold">{{ campaign.bidding }}</div>
            {% if campaign.target %}
              <div class="text-xs text-gray-500">Target: ${{ campaign.target }}</div>
            {% endif %}
          </div>
          <div>
            <div class="text-xs text-gray-500 mb-1">Ad Groups</div>
            <div class="text-lg font-semibold">{{ ad_groups|length }}</div>
          </div>
          <div>
            <div class="text-xs text-gray-500 mb-1">Total Keywords</div>
            <div class="text-lg font-semibold">{{ total_keywords }}</div>
          </div>
        </div>
      </div>

      <div class="flex gap-2">
        <button type="button"
                class="rounded-md border px-3 py-2 hover:bg-gray-50"
                onclick="editCampaign()">
          <i class="fa-solid fa-pen mr-2"></i>Edit Campaign
        </button>
        <a href="{{ url_for('google_bp.ads_campaigns') }}"
           class="rounded-md border px-3 py-2 hover:bg-gray-50">
          <i class="fa-solid fa-arrow-left mr-2"></i>Back to Campaigns
        </a>
      </div>
    </div>
  </div>

  {# Action Bar #}
  <div class="rounded-lg border bg-white p-4 flex items-center justify-between">
    <button type="button"
            class="inline-flex items-center gap-2 rounded-md bg-indigo-600 px-4 py-2 text-white hover:bg-indigo-700"
            onclick="showNewAdGroupModal()">
      <i class="fa-solid fa-plus"></i> New Ad Group
    </button>
    <div class="text-xs text-gray-500">
      {{ ad_groups|length }} ad group{{ 's' if ad_groups|length != 1 }} in this campaign
    </div>
  </div>

  {# Ad Groups List #}
  <div class="space-y-3">
    {% if ad_groups %}
      {% for ad_group in ad_groups %}
        {% set group_keywords = keywords | selectattr('ad_group_id', 'equalto', ad_group.id) | list %}
        {% set group_ads = ads | selectattr('ad_group_id', 'equalto', ad_group.id) | list %}
        {% set enabled_keywords = group_keywords | selectattr('status', 'equalto', 'Enabled') | list %}

        <div class="rounded-lg border bg-white hover:shadow-md transition-shadow">
          <div class="p-4">
            <div class="flex items-start justify-between">
              <div class="flex-1">
                <div class="flex items-center gap-3">
                  <h3 class="text-lg font-medium">{{ ad_group.name }}</h3>
                  <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium
                    {% if ad_group.status == 'Enabled' %}bg-green-50 text-green-700 border border-green-200
                    {% else %}bg-gray-50 text-gray-600 border border-gray-200{% endif %}">
                    {% if ad_group.status == 'Enabled' %}● {% endif %}{{ ad_group.status }}
                  </span>
                </div>

                <div class="mt-3 grid grid-cols-4 gap-4 text-sm">
                  <div>
                    <div class="text-gray-500">Keywords</div>
                    <div class="font-medium">{{ group_keywords|length }} ({{ enabled_keywords|length }} active)</div>
                  </div>
                  <div>
                    <div class="text-gray-500">Ads</div>
                    <div class="font-medium">{{ group_ads|length }}</div>
                  </div>
                  {% if group_keywords %}
                    {% set avg_cpc = (group_keywords | map(attribute='cpc') | select | sum) / (group_keywords | map(attribute='cpc') | select | list | length) %}
                    {% set total_conv = group_keywords | map(attribute='conv') | select | sum %}
                    <div>
                      <div class="text-gray-500">Avg CPC</div>
                      <div class="font-medium">${{ "%.2f"|format(avg_cpc) if avg_cpc else '--' }}</div>
                    </div>
                    <div>
                      <div class="text-gray-500">Conversions</div>
                      <div class="font-medium">{{ total_conv if total_conv else 0 }}</div>
                    </div>
                  {% endif %}
                </div>
              </div>

              <div class="flex items-center gap-2">
                <button type="button"
                        class="rounded-md border px-3 py-2 hover:bg-gray-50"
                        onclick="editAdGroup('{{ ad_group.id }}')">
                  <i class="fa-solid fa-pen text-gray-600"></i>
                </button>
                <a href="{{ url_for('google_bp.ads_adgroup_detail', campaign_id=campaign.id, adgroup_id=ad_group.id) }}"
                   class="inline-flex items-center gap-2 rounded-md bg-indigo-600 px-4 py-2 text-white hover:bg-indigo-700">
                  View Details <i class="fa-solid fa-arrow-right"></i>
                </a>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <div class="rounded-lg border bg-white p-8 text-center">
        <i class="fa-solid fa-layer-group text-4xl text-gray-300 mb-3"></i>
        <h3 class="text-lg font-medium text-gray-900 mb-2">No ad groups yet</h3>
        <p class="text-gray-500 mb-4">Create your first ad group to organize keywords and ads</p>
        <button type="button"
                class="inline-flex items-center gap-2 rounded-md bg-indigo-600 px-4 py-2 text-white hover:bg-indigo-700"
                onclick="showNewAdGroupModal()">
          <i class="fa-solid fa-plus"></i> Create Ad Group
        </button>
      </div>
    {% endif %}
  </div>
</div>

{# New Ad Group Modal #}
<div id="newAdGroupModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-xl max-w-lg w-full mx-4">
    <div class="px-6 py-4 border-b flex items-center justify-between">
      <h2 class="text-xl font-semibold">Create New Ad Group</h2>
      <button onclick="hideNewAdGroupModal()" class="text-gray-400 hover:text-gray-600">
        <i class="fa-solid fa-times text-xl"></i>
      </button>
    </div>
    <form method="post" action="{{ url_for('google_bp.ads_adgroup_create') }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <input type="hidden" name="campaign_id" value="{{ campaign.id }}">

      <div class="px-6 py-4 space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Ad Group Name</label>
          <input type="text" name="name" required
                 class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                 placeholder="e.g., Near Me">
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
          <select name="status"
                  class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <option value="Enabled">Enabled</option>
            <option value="Paused">Paused</option>
          </select>
        </div>

        <div class="bg-blue-50 border border-blue-200 rounded-md p-3">
          <div class="flex gap-2">
            <i class="fa-solid fa-info-circle text-blue-600 mt-0.5"></i>
            <div class="text-sm text-blue-800">
              <strong>Note:</strong> You'll add keywords and ads after creating the ad group.
            </div>
          </div>
        </div>
      </div>

      <div class="px-6 py-4 border-t flex items-center justify-end gap-3">
        <button type="button"
                onclick="hideNewAdGroupModal()"
                class="rounded-md border px-4 py-2 hover:bg-gray-50">
          Cancel
        </button>
        <button type="submit"
                class="rounded-md bg-indigo-600 px-4 py-2 text-white hover:bg-indigo-700">
          Create Ad Group
        </button>
      </div>
    </form>
  </div>
</div>

{# Edit Ad Group Modal #}
<div id="editAdGroupModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-xl max-w-lg w-full mx-4">
    <div class="px-6 py-4 border-b flex items-center justify-between">
      <h2 class="text-xl font-semibold">Edit Ad Group</h2>
      <button onclick="hideEditAdGroupModal()" class="text-gray-400 hover:text-gray-600">
        <i class="fa-solid fa-times text-xl"></i>
      </button>
    </div>
    <form method="post" action="{{ url_for('google_bp.ads_adgroup_update') }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <input type="hidden" name="id" id="edit_adgroup_id">
      <input type="hidden" name="campaign_id" value="{{ campaign.id }}">

      <div class="px-6 py-4 space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Ad Group Name</label>
          <input type="text" name="name" id="edit_adgroup_name" required
                 class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
          <select name="status" id="edit_adgroup_status"
                  class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <option value="Enabled">Enabled</option>
            <option value="Paused">Paused</option>
          </select>
        </div>
      </div>

      <div class="px-6 py-4 border-t flex items-center justify-between">
        <button type="button"
                onclick="deleteAdGroup()"
                class="rounded-md border border-red-300 text-red-600 px-4 py-2 hover:bg-red-50">
          <i class="fa-solid fa-trash mr-2"></i>Delete Ad Group
        </button>
        <div class="flex gap-3">
          <button type="button"
                  onclick="hideEditAdGroupModal()"
                  class="rounded-md border px-4 py-2 hover:bg-gray-50">
            Cancel
          </button>
          <button type="submit"
                  class="rounded-md bg-indigo-600 px-4 py-2 text-white hover:bg-indigo-700">
            Save Changes
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

{# Edit Campaign Modal #}
<div id="editCampaignModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4">
    <div class="px-6 py-4 border-b flex items-center justify-between">
      <h2 class="text-xl font-semibold">Edit Campaign</h2>
      <button onclick="hideEditCampaignModal()" class="text-gray-400 hover:text-gray-600">
        <i class="fa-solid fa-times text-xl"></i>
      </button>
    </div>
    <form method="post" action="{{ url_for('google_bp.ads_campaign_update') }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <input type="hidden" name="id" value="{{ campaign.id }}">

      <div class="px-6 py-4 space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Campaign Name</label>
          <input type="text" name="name" value="{{ campaign.name }}" required
                 class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Campaign Type</label>
            <select name="type" required
                    class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
              <option value="SEARCH" {% if campaign.type == 'SEARCH' %}selected{% endif %}>Search</option>
              <option value="DISPLAY" {% if campaign.type == 'DISPLAY' %}selected{% endif %}>Display</option>
              <option value="VIDEO" {% if campaign.type == 'VIDEO' %}selected{% endif %}>Video</option>
              <option value="SHOPPING" {% if campaign.type == 'SHOPPING' %}selected{% endif %}>Shopping</option>
              <option value="PERFORMANCE_MAX" {% if campaign.type == 'PERFORMANCE_MAX' %}selected{% endif %}>Performance Max</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
            <select name="status"
                    class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
              <option value="Enabled" {% if campaign.status == 'Enabled' %}selected{% endif %}>Enabled</option>
              <option value="Paused" {% if campaign.status == 'Paused' %}selected{% endif %}>Paused</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Daily Budget ($)</label>
            <input type="number" name="daily_budget" value="{{ campaign.daily_budget }}" step="0.01" min="0" required
                   class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Bidding Strategy</label>
            <select name="bidding" required
                    class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
              <option value="Manual CPC" {% if campaign.bidding == 'Manual CPC' %}selected{% endif %}>Manual CPC</option>
              <option value="Enhanced CPC" {% if campaign.bidding == 'Enhanced CPC' %}selected{% endif %}>Enhanced CPC</option>
              <option value="Maximize Clicks" {% if campaign.bidding == 'Maximize Clicks' %}selected{% endif %}>Maximize Clicks</option>
              <option value="Maximize Conversions" {% if campaign.bidding == 'Maximize Conversions' %}selected{% endif %}>Maximize Conversions</option>
              <option value="Target CPA" {% if campaign.bidding == 'Target CPA' or campaign.bidding == 'tCPA' %}selected{% endif %}>Target CPA</option>
              <option value="Target ROAS" {% if campaign.bidding == 'Target ROAS' %}selected{% endif %}>Target ROAS</option>
            </select>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Target CPA/ROAS ($)</label>
          <input type="number" name="target" value="{{ campaign.target if campaign.target else '' }}" step="0.01" min="0"
                 class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
        </div>
      </div>

      <div class="px-6 py-4 border-t flex items-center justify-end gap-3">
        <button type="button"
                onclick="hideEditCampaignModal()"
                class="rounded-md border px-4 py-2 hover:bg-gray-50">
          Cancel
        </button>
        <button type="submit"
                class="rounded-md bg-indigo-600 px-4 py-2 text-white hover:bg-indigo-700">
          Save Changes
        </button>
      </div>
    </form>
  </div>
</div>

<script nonce="{{ g.csp_nonce }}">
// Ad groups data
const adGroupsData = {{ ad_groups | tojson }};

function showNewAdGroupModal() {
  document.getElementById('newAdGroupModal').classList.remove('hidden');
  document.getElementById('newAdGroupModal').classList.add('flex');
}

function hideNewAdGroupModal() {
  document.getElementById('newAdGroupModal').classList.add('hidden');
  document.getElementById('newAdGroupModal').classList.remove('flex');
}

function editAdGroup(adGroupId) {
  const adGroup = adGroupsData.find(g => g.id === adGroupId);
  if (!adGroup) return;

  document.getElementById('edit_adgroup_id').value = adGroup.id;
  document.getElementById('edit_adgroup_name').value = adGroup.name;
  document.getElementById('edit_adgroup_status').value = adGroup.status;

  document.getElementById('editAdGroupModal').classList.remove('hidden');
  document.getElementById('editAdGroupModal').classList.add('flex');
}

function hideEditAdGroupModal() {
  document.getElementById('editAdGroupModal').classList.add('hidden');
  document.getElementById('editAdGroupModal').classList.remove('flex');
}

function deleteAdGroup() {
  const adGroupId = document.getElementById('edit_adgroup_id').value;
  if (!confirm('Are you sure you want to delete this ad group? All keywords and ads in this ad group will also be deleted.')) {
    return;
  }

  const form = document.createElement('form');
  form.method = 'POST';
  form.action = '{{ url_for("google_bp.ads_adgroup_delete") }}';

  const csrfInput = document.createElement('input');
  csrfInput.type = 'hidden';
  csrfInput.name = 'csrf_token';
  csrfInput.value = '{{ csrf_token() }}';

  const idInput = document.createElement('input');
  idInput.type = 'hidden';
  idInput.name = 'id';
  idInput.value = adGroupId;

  const campaignInput = document.createElement('input');
  campaignInput.type = 'hidden';
  campaignInput.name = 'campaign_id';
  campaignInput.value = '{{ campaign.id }}';

  form.appendChild(csrfInput);
  form.appendChild(idInput);
  form.appendChild(campaignInput);
  document.body.appendChild(form);
  form.submit();
}

function editCampaign() {
  document.getElementById('editCampaignModal').classList.remove('hidden');
  document.getElementById('editCampaignModal').classList.add('flex');
}

function hideEditCampaignModal() {
  document.getElementById('editCampaignModal').classList.add('hidden');
  document.getElementById('editCampaignModal').classList.remove('flex');
}

// Close modals on escape key
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    hideNewAdGroupModal();
    hideEditAdGroupModal();
    hideEditCampaignModal();
  }
});

// Close modals on background click
['newAdGroupModal', 'editAdGroupModal', 'editCampaignModal'].forEach(modalId => {
  const modal = document.getElementById(modalId);
  if (modal) {
    modal.addEventListener('click', (e) => {
      if (e.target.id === modalId) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      }
    });
  }
});
</script>
{% endblock %}
