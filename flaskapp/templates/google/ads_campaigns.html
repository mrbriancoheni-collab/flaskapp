{# templates/google/ads_campaigns.html - Level 1: Campaigns List #}
{% extends "base_app.html" %}
{% set SECTION = 'google' %}
{% block title %}Google Ads - Campaigns{% endblock %}

{% block content %}
{% set _connected = (connected if connected is defined else false) %}
{% set _ai_connected = (ai_connected if ai_connected is defined else false) %}
{% set _data = (ads_data if ads_data is defined and ads_data else {}) %}

<div class="max-w-7xl mx-auto space-y-6">
  {# Header #}
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-semibold">Google Ads</h1>
      <p class="text-gray-500">
        {% if _connected %}
          Managing <span class="font-medium">{{ _data.account_name or 'Google Ads Account' }}</span>
        {% else %}
          <span class="inline-flex items-center rounded-full bg-gray-100 text-gray-700 border border-gray-200 px-2 py-0.5 text-[11px] mr-2">Demo Mode</span>
          Sample campaigns to demonstrate UI
        {% endif %}
      </p>
    </div>
    <div class="flex items-center gap-2">
      <span class="inline-flex items-center rounded-full {{ 'bg-green-50 text-green-700 border border-green-200' if _ai_connected else 'bg-amber-50 text-amber-700 border border-amber-200' }} px-2 py-0.5 text-xs">
        <i class="fa-solid fa-robot mr-1"></i> AI {{ 'enabled' if _ai_connected else 'disabled' }}
      </span>
      {% if _connected %}
        <form method="post" action="{{ url_for('google_bp.disconnect', product='ads') }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button class="rounded-md border px-3 py-2 hover:bg-gray-50" type="submit">
            <i class="fa-solid fa-plug-circle-xmark mr-2"></i>Disconnect
          </button>
        </form>
      {% else %}
        <a href="{{ url_for('google_bp.connect_ads') }}"
           class="inline-flex items-center gap-2 rounded-md bg-indigo-600 px-4 py-2 text-white hover:bg-indigo-700">
          <i class="fa-solid fa-link"></i> Connect Google Ads
        </a>
      {% endif %}
    </div>
  </div>

  {# Action Bar #}
  <div class="rounded-lg border bg-white p-4 flex flex-wrap items-center justify-between gap-3">
    <div class="flex items-center gap-2">
      <button type="button"
              class="inline-flex items-center gap-2 rounded-md bg-indigo-600 px-4 py-2 text-white hover:bg-indigo-700"
              onclick="showNewCampaignModal()">
        <i class="fa-solid fa-plus"></i> New Campaign
      </button>

      <button type="button"
              class="inline-flex items-center gap-2 rounded-md border px-3 py-2 hover:bg-gray-50"
              onclick="aiOptimize()">
        <i class="fa-solid fa-wand-magic-sparkles"></i> AI Optimize
      </button>

      <button type="button"
              class="inline-flex items-center gap-2 rounded-md border px-3 py-2 hover:bg-gray-50"
              onclick="refreshData()">
        <i class="fa-solid fa-rotate"></i> Refresh
      </button>
    </div>
    <div class="text-xs text-gray-500">
      {% if _connected %}Live data{% else %}Demo mode{% endif %}
    </div>
  </div>

  {# Campaigns List #}
  <div class="space-y-4">
    {% if _data.campaigns %}
      {% for campaign in _data.campaigns %}
        {% set campaign_ad_groups = _data.ad_groups | selectattr('campaign_id', 'equalto', campaign.id) | list %}
        {% set ad_group_ids = campaign_ad_groups | map(attribute='id') | list %}
        {% set campaign_keywords = _data.keywords | selectattr('ad_group_id', 'in', ad_group_ids) | list %}
        {% set campaign_ads = _data.ads | selectattr('ad_group_id', 'in', ad_group_ids) | list %}

        <div class="rounded-lg border bg-white hover:shadow-md transition-shadow">
          <div class="p-4">
            <div class="flex items-start justify-between">
              <div class="flex-1">
                <div class="flex items-center gap-3">
                  <h3 class="text-lg font-medium">{{ campaign.name }}</h3>
                  <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium
                    {% if campaign.status == 'Enabled' %}bg-green-50 text-green-700 border border-green-200
                    {% else %}bg-gray-50 text-gray-600 border border-gray-200{% endif %}">
                    {% if campaign.status == 'Enabled' %}‚óè {% endif %}{{ campaign.status }}
                  </span>
                  <span class="text-sm text-gray-500">{{ campaign.type }}</span>
                </div>

                <div class="mt-2 flex items-center gap-6 text-sm text-gray-600">
                  <div>
                    <span class="font-medium text-gray-900">${{ campaign.daily_budget }}</span>
                    <span class="text-gray-500">/day</span>
                  </div>
                  <div>
                    <span class="text-gray-500">Bidding:</span>
                    <span class="font-medium text-gray-900">{{ campaign.bidding }}</span>
                    {% if campaign.target %}
                      <span class="text-gray-500">(${{ campaign.target }})</span>
                    {% endif %}
                  </div>
                </div>

                <div class="mt-3 flex items-center gap-4 text-sm text-gray-500">
                  <span><i class="fa-solid fa-layer-group mr-1"></i>{{ campaign_ad_groups|length }} ad group{{ 's' if campaign_ad_groups|length != 1 }}</span>
                  <span><i class="fa-solid fa-key mr-1"></i>{{ campaign_keywords|length }} keyword{{ 's' if campaign_keywords|length != 1 }}</span>
                  <span><i class="fa-solid fa-rectangle-ad mr-1"></i>{{ campaign_ads|length }} ad{{ 's' if campaign_ads|length != 1 }}</span>
                </div>
              </div>

              <div class="flex items-center gap-2">
                <button type="button"
                        class="rounded-md border px-3 py-2 hover:bg-gray-50"
                        onclick="editCampaign('{{ campaign.id }}')">
                  <i class="fa-solid fa-pen text-gray-600"></i>
                </button>
                <a href="{{ url_for('google_bp.ads_campaign_detail', campaign_id=campaign.id) }}"
                   class="inline-flex items-center gap-2 rounded-md bg-indigo-600 px-4 py-2 text-white hover:bg-indigo-700">
                  View Details <i class="fa-solid fa-arrow-right"></i>
                </a>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <div class="rounded-lg border bg-white p-8 text-center">
        <i class="fa-solid fa-bullhorn text-4xl text-gray-300 mb-3"></i>
        <h3 class="text-lg font-medium text-gray-900 mb-2">No campaigns yet</h3>
        <p class="text-gray-500 mb-4">Get started by creating your first campaign</p>
        <button type="button"
                class="inline-flex items-center gap-2 rounded-md bg-indigo-600 px-4 py-2 text-white hover:bg-indigo-700"
                onclick="showNewCampaignModal()">
          <i class="fa-solid fa-plus"></i> Create Campaign
        </button>
      </div>
    {% endif %}
  </div>

  {# AI Suggestions Panel #}
  <div class="rounded-lg border bg-white">
    <div class="px-4 py-3 border-b flex items-center justify-between">
      <div class="font-medium">AI Suggestions</div>
      <button type="button"
              class="text-sm text-indigo-600 hover:text-indigo-700"
              onclick="runAIReview()">
        <i class="fa-solid fa-wand-magic-sparkles mr-1"></i> Generate Insights
      </button>
    </div>
    <div class="p-4" id="aiSuggestionsContent">
      <p class="text-sm text-gray-500 text-center py-4">Click "Generate Insights" to get AI-powered recommendations</p>
    </div>
  </div>
</div>

{# AI Insights Modal #}
{% include 'google/components/insights_modal.html' %}

{# New Campaign Modal #}
<div id="newCampaignModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4">
    <div class="px-6 py-4 border-b flex items-center justify-between">
      <h2 class="text-xl font-semibold">Create New Campaign</h2>
      <button onclick="hideNewCampaignModal()" class="text-gray-400 hover:text-gray-600">
        <i class="fa-solid fa-times text-xl"></i>
      </button>
    </div>
    <form id="newCampaignForm" method="post" action="{{ url_for('google_bp.ads_campaign_create') }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <div class="px-6 py-4 space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Campaign Name</label>
          <input type="text" name="name" required
                 class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                 placeholder="e.g., Emergency Plumbing - Search">
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Campaign Type</label>
            <select name="type" required
                    class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
              <option value="SEARCH">Search</option>
              <option value="DISPLAY">Display</option>
              <option value="VIDEO">Video</option>
              <option value="SHOPPING">Shopping</option>
              <option value="PERFORMANCE_MAX">Performance Max</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
            <select name="status"
                    class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
              <option value="Enabled">Enabled</option>
              <option value="Paused" selected>Paused</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Daily Budget ($)</label>
            <input type="number" name="daily_budget" step="0.01" min="0" required
                   class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                   placeholder="50.00">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Bidding Strategy</label>
            <select name="bidding" required
                    class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
              <option value="Manual CPC">Manual CPC</option>
              <option value="Enhanced CPC">Enhanced CPC</option>
              <option value="Maximize Clicks">Maximize Clicks</option>
              <option value="Maximize Conversions">Maximize Conversions</option>
              <option value="Target CPA">Target CPA</option>
              <option value="Target ROAS">Target ROAS</option>
            </select>
          </div>
        </div>

        <div id="targetField" class="hidden">
          <label class="block text-sm font-medium text-gray-700 mb-1">Target CPA/ROAS ($)</label>
          <input type="number" name="target" step="0.01" min="0"
                 class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                 placeholder="65.00">
        </div>
      </div>

      <div class="px-6 py-4 border-t flex items-center justify-end gap-3">
        <button type="button"
                onclick="hideNewCampaignModal()"
                class="rounded-md border px-4 py-2 hover:bg-gray-50">
          Cancel
        </button>
        <button type="submit"
                class="rounded-md bg-indigo-600 px-4 py-2 text-white hover:bg-indigo-700">
          Create Campaign
        </button>
      </div>
    </form>
  </div>
</div>

{# Edit Campaign Modal #}
<div id="editCampaignModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4">
    <div class="px-6 py-4 border-b flex items-center justify-between">
      <h2 class="text-xl font-semibold">Edit Campaign</h2>
      <button onclick="hideEditCampaignModal()" class="text-gray-400 hover:text-gray-600">
        <i class="fa-solid fa-times text-xl"></i>
      </button>
    </div>
    <form id="editCampaignForm" method="post" action="{{ url_for('google_bp.ads_campaign_update') }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <input type="hidden" name="id" id="edit_campaign_id">

      <div class="px-6 py-4 space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Campaign Name</label>
          <input type="text" name="name" id="edit_campaign_name" required
                 class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Campaign Type</label>
            <select name="type" id="edit_campaign_type" required
                    class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
              <option value="SEARCH">Search</option>
              <option value="DISPLAY">Display</option>
              <option value="VIDEO">Video</option>
              <option value="SHOPPING">Shopping</option>
              <option value="PERFORMANCE_MAX">Performance Max</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
            <select name="status" id="edit_campaign_status"
                    class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
              <option value="Enabled">Enabled</option>
              <option value="Paused">Paused</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Daily Budget ($)</label>
            <input type="number" name="daily_budget" id="edit_campaign_budget" step="0.01" min="0" required
                   class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Bidding Strategy</label>
            <select name="bidding" id="edit_campaign_bidding" required
                    class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
              <option value="Manual CPC">Manual CPC</option>
              <option value="Enhanced CPC">Enhanced CPC</option>
              <option value="Maximize Clicks">Maximize Clicks</option>
              <option value="Maximize Conversions">Maximize Conversions</option>
              <option value="Target CPA">Target CPA</option>
              <option value="Target ROAS">Target ROAS</option>
            </select>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Target CPA/ROAS ($)</label>
          <input type="number" name="target" id="edit_campaign_target" step="0.01" min="0"
                 class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
        </div>
      </div>

      <div class="px-6 py-4 border-t flex items-center justify-between">
        <button type="button"
                onclick="deleteCampaign()"
                class="rounded-md border border-red-300 text-red-600 px-4 py-2 hover:bg-red-50">
          <i class="fa-solid fa-trash mr-2"></i>Delete Campaign
        </button>
        <div class="flex gap-3">
          <button type="button"
                  onclick="hideEditCampaignModal()"
                  class="rounded-md border px-4 py-2 hover:bg-gray-50">
            Cancel
          </button>
          <button type="submit"
                  class="rounded-md bg-indigo-600 px-4 py-2 text-white hover:bg-indigo-700">
            Save Changes
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

{# Include AI Insights JavaScript #}
<script src="{{ url_for('static', filename='js/google_ads_insights.js') }}" nonce="{{ g.csp_nonce }}"></script>

<script nonce="{{ g.csp_nonce }}">
// Campaign data from backend
const campaignsData = {{ _data.campaigns | tojson }};

function showNewCampaignModal() {
  document.getElementById('newCampaignModal').classList.remove('hidden');
  document.getElementById('newCampaignModal').classList.add('flex');

  // Show/hide target field based on bidding strategy
  const biddingSelect = document.querySelector('#newCampaignForm select[name="bidding"]');
  const targetField = document.getElementById('targetField');

  biddingSelect.addEventListener('change', () => {
    if (biddingSelect.value === 'Target CPA' || biddingSelect.value === 'Target ROAS') {
      targetField.classList.remove('hidden');
    } else {
      targetField.classList.add('hidden');
    }
  });
}

function hideNewCampaignModal() {
  document.getElementById('newCampaignModal').classList.add('hidden');
  document.getElementById('newCampaignModal').classList.remove('flex');
}

function editCampaign(campaignId) {
  const campaign = campaignsData.find(c => c.id === campaignId);
  if (!campaign) return;

  document.getElementById('edit_campaign_id').value = campaign.id;
  document.getElementById('edit_campaign_name').value = campaign.name;
  document.getElementById('edit_campaign_type').value = campaign.type;
  document.getElementById('edit_campaign_status').value = campaign.status;
  document.getElementById('edit_campaign_budget').value = campaign.daily_budget;
  document.getElementById('edit_campaign_bidding').value = campaign.bidding;
  document.getElementById('edit_campaign_target').value = campaign.target || '';

  document.getElementById('editCampaignModal').classList.remove('hidden');
  document.getElementById('editCampaignModal').classList.add('flex');
}

function hideEditCampaignModal() {
  document.getElementById('editCampaignModal').classList.add('hidden');
  document.getElementById('editCampaignModal').classList.remove('flex');
}

function deleteCampaign() {
  const campaignId = document.getElementById('edit_campaign_id').value;
  if (!confirm('Are you sure you want to delete this campaign? This action cannot be undone.')) {
    return;
  }

  const form = document.createElement('form');
  form.method = 'POST';
  form.action = '{{ url_for("google_bp.ads_campaign_delete") }}';

  const csrfInput = document.createElement('input');
  csrfInput.type = 'hidden';
  csrfInput.name = 'csrf_token';
  csrfInput.value = '{{ csrf_token() }}';

  const idInput = document.createElement('input');
  idInput.type = 'hidden';
  idInput.name = 'id';
  idInput.value = campaignId;

  form.appendChild(csrfInput);
  form.appendChild(idInput);
  document.body.appendChild(form);
  form.submit();
}

// aiOptimize() is now defined in google_ads_insights.js

function refreshData() {
  window.location.reload();
}

function runAIReview() {
  aiOptimize(); // Use the same AI insights modal
}

// Close modals on escape key
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    hideNewCampaignModal();
    hideEditCampaignModal();
  }
});

// Close modals on background click
document.getElementById('newCampaignModal').addEventListener('click', (e) => {
  if (e.target.id === 'newCampaignModal') {
    hideNewCampaignModal();
  }
});

document.getElementById('editCampaignModal').addEventListener('click', (e) => {
  if (e.target.id === 'editCampaignModal') {
    hideEditCampaignModal();
  }
});
</script>
{% endblock %}
