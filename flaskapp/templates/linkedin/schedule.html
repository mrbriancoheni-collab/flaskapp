{# templates/linkedin/schedule.html #}
{% extends "base_app.html" %}
{% set SECTION = 'linkedin' %}
{% block title %}Scheduled LinkedIn Posts{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto space-y-6">
  <!-- Header -->
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-semibold">Scheduled LinkedIn Posts</h1>
      <p class="text-gray-500 mt-1">
        Manage your upcoming thought leader posts (max 1 per day, up to 1 week ahead)
      </p>
    </div>
    <a
      href="{{ url_for('linkedin_bp.post_generator') }}"
      class="inline-flex items-center gap-2 rounded-md bg-blue-600 px-4 py-2 text-white hover:bg-blue-700"
    >
      <i class="fa-solid fa-plus"></i>
      Create New Post
    </a>
  </div>

  <!-- Stats -->
  <div class="grid md:grid-cols-3 gap-4">
    <div class="rounded-lg border bg-white p-4">
      <div class="text-sm text-gray-500 mb-1">Total Scheduled</div>
      <div class="text-2xl font-semibold">{{ scheduled_posts|length }}</div>
    </div>
    <div class="rounded-lg border bg-white p-4">
      <div class="text-sm text-gray-500 mb-1">Days Covered</div>
      <div class="text-2xl font-semibold">{{ scheduled_posts|length }}/7</div>
    </div>
    <div class="rounded-lg border bg-white p-4">
      <div class="text-sm text-gray-500 mb-1">Next Post</div>
      <div class="text-lg font-semibold">
        {% if scheduled_posts %}
          {{ scheduled_posts[0].scheduled_date.strftime('%b %d') }}
        {% else %}
          <span class="text-gray-400">None</span>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Scheduled Posts -->
  {% if scheduled_posts %}
    <div class="space-y-4">
      {% for post in scheduled_posts %}
        <div class="rounded-lg border bg-white p-6 hover:shadow-md transition">
          <div class="flex items-start justify-between gap-4 mb-4">
            <div class="flex-1">
              <div class="flex items-center gap-3 mb-2">
                <div class="text-lg font-semibold text-blue-600">
                  <i class="fa-solid fa-calendar-day mr-2"></i>
                  {{ post.scheduled_date.strftime('%A, %B %d, %Y') }}
                </div>
                {% if post.scheduled_time %}
                  <span class="inline-flex items-center rounded-full bg-blue-50 text-blue-700 border border-blue-200 px-2 py-0.5 text-xs">
                    <i class="fa-solid fa-clock mr-1"></i>
                    {{ post.scheduled_time }}
                  </span>
                {% endif %}
              </div>

              {% if post.topic %}
                <div class="text-sm text-gray-600 mb-1">
                  <strong>Topic:</strong> {{ post.topic }}
                </div>
              {% endif %}

              {% if post.industry or post.tone %}
                <div class="flex gap-3 text-xs text-gray-500">
                  {% if post.industry %}
                    <span><i class="fa-solid fa-tag mr-1"></i>{{ post.industry }}</span>
                  {% endif %}
                  {% if post.tone %}
                    <span><i class="fa-solid fa-pen-fancy mr-1"></i>{{ post.tone }}</span>
                  {% endif %}
                </div>
              {% endif %}
            </div>

            <div class="flex items-center gap-2">
              <button
                class="view-post-btn px-3 py-1 text-sm border rounded-md hover:bg-gray-50"
                data-post-id="{{ post.id }}"
                title="View post"
              >
                <i class="fa-solid fa-eye"></i>
              </button>
              <button
                class="edit-post-btn px-3 py-1 text-sm border rounded-md hover:bg-gray-50"
                data-post-id="{{ post.id }}"
                title="Edit date/time"
              >
                <i class="fa-solid fa-pen"></i>
              </button>
              <button
                class="delete-post-btn px-3 py-1 text-sm border border-red-200 text-red-600 rounded-md hover:bg-red-50"
                data-post-id="{{ post.id }}"
                title="Delete"
              >
                <i class="fa-solid fa-trash"></i>
              </button>
            </div>
          </div>

          <!-- Post Preview (collapsible) -->
          <div id="post-preview-{{ post.id }}" class="hidden mt-4 pt-4 border-t">
            <div class="bg-gray-50 rounded-lg p-4 max-h-64 overflow-y-auto">
              <div class="text-sm whitespace-pre-wrap leading-relaxed text-gray-700">{{ post.post_text }}</div>
            </div>
            <div class="mt-3 flex gap-2">
              <button
                class="copy-post-btn px-3 py-1 text-sm border rounded-md hover:bg-gray-50"
                data-post-text="{{ post.post_text }}"
              >
                <i class="fa-solid fa-copy mr-1"></i>Copy Text
              </button>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <!-- Empty State -->
    <div class="rounded-lg border bg-white p-12 text-center">
      <div class="text-gray-400 mb-4">
        <i class="fa-solid fa-calendar-xmark text-6xl"></i>
      </div>
      <h3 class="text-lg font-semibold text-gray-700 mb-2">No Scheduled Posts</h3>
      <p class="text-gray-500 mb-6">Create your first thought leader post and schedule it for later.</p>
      <a
        href="{{ url_for('linkedin_bp.post_generator') }}"
        class="inline-flex items-center gap-2 rounded-md bg-blue-600 px-4 py-2 text-white hover:bg-blue-700"
      >
        <i class="fa-solid fa-wand-magic-sparkles"></i>
        Generate Your First Post
      </a>
    </div>
  {% endif %}

  <!-- Tips -->
  <div class="rounded-lg border bg-gradient-to-br from-blue-50 to-indigo-50 p-6">
    <h3 class="font-semibold text-blue-900 mb-3">
      <i class="fa-solid fa-lightbulb mr-2"></i>Scheduling Tips
    </h3>
    <ul class="space-y-2 text-sm text-blue-800">
      <li><i class="fa-solid fa-check mr-2 text-blue-600"></i>Post consistently - schedule 1 post per day for best results</li>
      <li><i class="fa-solid fa-check mr-2 text-blue-600"></i>Plan your content calendar up to 1 week in advance</li>
      <li><i class="fa-solid fa-check mr-2 text-blue-600"></i>Best posting times: weekday mornings (7-9 AM) and lunch (12-1 PM)</li>
      <li><i class="fa-solid fa-check mr-2 text-blue-600"></i>Review scheduled posts regularly and adjust based on engagement</li>
      <li><i class="fa-solid fa-check mr-2 text-blue-600"></i>Copy the post text when ready and manually post to LinkedIn</li>
    </ul>
  </div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
  <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
    <h3 class="text-lg font-semibold mb-4">
      <i class="fa-solid fa-pen mr-2"></i>Edit Schedule
    </h3>

    <form id="editForm" class="space-y-4">
      <input type="hidden" id="editPostId" />

      <div>
        <label for="editDate" class="block text-sm font-medium text-gray-700 mb-1">
          Date
        </label>
        <input
          type="date"
          id="editDate"
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          required
        />
      </div>

      <div>
        <label for="editTime" class="block text-sm font-medium text-gray-700 mb-1">
          Time
        </label>
        <input
          type="time"
          id="editTime"
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
        />
      </div>

      <div class="flex gap-2">
        <button
          type="submit"
          class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"
        >
          Save Changes
        </button>
        <button
          type="button"
          id="cancelEditBtn"
          class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50"
        >
          Cancel
        </button>
      </div>
    </form>
  </div>
</div>

<script>
// Set min and max dates for edit date picker
const editDateInput = document.getElementById('editDate');
if (editDateInput) {
  const today = new Date();
  const maxDate = new Date();
  maxDate.setDate(today.getDate() + 7);

  editDateInput.min = today.toISOString().split('T')[0];
  editDateInput.max = maxDate.toISOString().split('T')[0];
}

// View post toggle
document.querySelectorAll('.view-post-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    const postId = this.dataset.postId;
    const preview = document.getElementById(`post-preview-${postId}`);

    if (preview.classList.contains('hidden')) {
      preview.classList.remove('hidden');
      this.innerHTML = '<i class="fa-solid fa-eye-slash"></i>';
    } else {
      preview.classList.add('hidden');
      this.innerHTML = '<i class="fa-solid fa-eye"></i>';
    }
  });
});

// Copy post text
document.querySelectorAll('.copy-post-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    const postText = this.dataset.postText;
    navigator.clipboard.writeText(postText).then(() => {
      const originalText = this.innerHTML;
      this.innerHTML = '<i class="fa-solid fa-check mr-1"></i>Copied!';
      setTimeout(() => {
        this.innerHTML = originalText;
      }, 2000);
    });
  });
});

// Edit post
document.querySelectorAll('.edit-post-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    const postId = this.dataset.postId;

    // TODO: Fetch post data and populate form
    // For now, just show modal
    document.getElementById('editPostId').value = postId;
    document.getElementById('editModal').style.display = 'flex';
    document.getElementById('editModal').classList.remove('hidden');
  });
});

// Cancel edit
document.getElementById('cancelEditBtn')?.addEventListener('click', function() {
  document.getElementById('editModal').style.display = 'none';
  document.getElementById('editModal').classList.add('hidden');
});

// Submit edit
document.getElementById('editForm')?.addEventListener('submit', async function(e) {
  e.preventDefault();

  const postId = document.getElementById('editPostId').value;
  const newDate = document.getElementById('editDate').value;
  const newTime = document.getElementById('editTime').value;

  const formData = new FormData();
  formData.append('scheduled_date', newDate);
  formData.append('scheduled_time', newTime);

  try {
    const response = await fetch(`/account/linkedin/schedule/${postId}/update`, {
      method: 'POST',
      body: formData
    });

    const data = await response.json();

    if (data.error) {
      alert('Error: ' + data.error);
      return;
    }

    alert('Schedule updated successfully!');
    window.location.reload();

  } catch (error) {
    console.error('Error:', error);
    alert('Failed to update schedule. Please try again.');
  }
});

// Delete post
document.querySelectorAll('.delete-post-btn').forEach(btn => {
  btn.addEventListener('click', async function() {
    const postId = this.dataset.postId;

    if (!confirm('Are you sure you want to delete this scheduled post?')) {
      return;
    }

    try {
      const response = await fetch(`/account/linkedin/schedule/${postId}/delete`, {
        method: 'POST'
      });

      const data = await response.json();

      if (data.error) {
        alert('Error: ' + data.error);
        return;
      }

      alert('Scheduled post deleted successfully!');
      window.location.reload();

    } catch (error) {
      console.error('Error:', error);
      alert('Failed to delete scheduled post. Please try again.');
    }
  });
});
</script>
{% endblock %}
